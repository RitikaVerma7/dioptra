name: tensorflow-mnist-classifier

entry_points:
  gen_poison:
    parameters:
      data_dir: {type: path, default: "/nfs/data"}
      target_image_path: {type: path, default: "None"}
      model: {type: string, default: "mnist_le_net/1"}
      model_architecture: {type: string, default: "vgg16"}
      learning_rate: {type: float, default: 5.0}
      max_iter: {type: int, default: 500}
      decay_coeff: {type: float, default: 0.5}
      stopping_tol: {type: float, default: 1e-10}
      similarity_coeff: {type: float, default: 256.0}
      watermark: {type: float, default: -1}
      num_old_obj: {type: int, default: 40}
      obj_threshold: {type: float, default: -1}
      target_class: {type: string, default: "0"}
      batch_size: {type: int, default: 30}
      num_poisoned_batches: {type: int, default: -1}
      feature_layer_index: {type: int, default: -1}
      seed: {type: float, default: -1}
    command: >
      python src/gen_poison.py
      --data-dir {data_dir}
      --target-image-path {target_image_path}
      --model {model}
      --model-architecture {model_architecture}
      --learning-rate {learning_rate}
      --max-iter {max_iter}
      --decay-coeff {decay_coeff}
      --stopping-tol {stopping_tol}
      --similarity-coeff {similarity_coeff}
      --watermark {watermark}
      --num-old-obj {num_old_obj}
      --obj-threshold {obj_threshold}
      --target-class {target_class}
      --batch-size {batch_size}
      --num-poisoned-batches {num_poisoned_batches}
      --feature-layer-index {feature_layer_index}
      --seed {seed}

  deploy_poison:
    parameters:
      run_id: {type: string}
      data_dir: {type: path, default: "/nfs/data"}
      poison_deployment_method: {type: string, default: "add"}
      num_poisoned_images: {type: int, default: -1}
      seed: {type: float, default: -1}
    command: >
      python src/deploy_poison.py
      --run-id {run_id}
      --data-dir {data_dir}
      --poison-deployment-method {poison_deployment_method}
      --num-poisoned-images {num_poisoned_images}
      --seed {seed}

  init_model:
    parameters:
      data_dir: {type: path, default: "/nfs/data/ImageNet-Kaggle-2017/images/ILSVRC/Data/CLS-LOC/val-sorted-5000"}
      model_tag: {type: string, default: "default_pretrained"}
      model_architecture: {type: string, default: "resnet50"}
      batch_size: {type: float, default: 10}
      seed: {type: float, default: -1}
    command: >
      python src/init_model.py
      --data-dir {data_dir}
      --model-tag {model_tag}
      --model-architecture {model_architecture}
      --batch-size {batch_size}
      --seed {seed}

  infer:
    parameters:
      run_id: {type: string}
      model: {type: string, default: "mnist_le_net/1"}
      model_architecture: {type: string, default: "le_net"}
      batch_size: {type: float, default: 32}
      seed: {type: float, default: -1}
      dataset_tar_name: {type: string, default: "testing_adversarial_fgm.tar.gz"}
      dataset_name: {type: string, default: "adv_testing"}
    command: >
      python src/infer.py
      --run-id {run_id}
      --model {model}
      --model-architecture {model_architecture}
      --batch-size {batch_size}
      --seed {seed}
      --dataset-tar-name {dataset_tar_name}
      --dataset-name {dataset_name}

  train:
    parameters:
      model_tag: {type: string, default: ""}
      data_dir_train: {type: path, default: "/nfs/data/training"}
      data_dir_test: {type: path, default: "/nfs/data/testing"}
      model_architecture: {type: string, default: "vgg16"}
      epochs: {type: float, default: 30}
      batch_size: {type: float, default: 32}
      register_model: {type: string, default: "False"}
      learning_rate: {type: float, default: 0.001}
      optimizer: {type: string, default: "adam"}
      validation_split: {type: float, default: 0.2}
      load_dataset_from_mlruns: {type: string, default: "False"}
      training_dataset_run_id: {type: string, default: "None"}
      seed: {type: float, default: -1}
    command: >
      python src/train.py
      --data-dir-train {data_dir_train}
      --data-dir-test {data_dir_test}
      --model-architecture {model_architecture}
      --model-tag {model_tag}
      --epochs {epochs}
      --batch-size {batch_size}
      --register-model {register_model}
      --learning-rate {learning_rate}
      --optimizer {optimizer}
      --validation-split {validation_split}
      --load-dataset-from-mlruns {load_dataset_from_mlruns}
      --training-dataset-run-id {training_dataset_run_id}
      --seed {seed}
